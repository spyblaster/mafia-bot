# بات تلگرامی شب مافیا

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

بات تلگرامی "مافیا" یک ابزار خودکار برای مدیریت بازی مافیا به صورت حضوری است. هدف اصلی این بات جلوگیری از اتلاف وقت بازیکنان هنگام نقش گرفتن است، به این صورت که هر بازیکن با استفاده از گوشی هوشمند خود نقش بگیرد. این بات به گرداننده بازی امکان می‌دهد تا سناریوها، تعداد بازیکنان، و نقش‌ها را تنظیم کند و به بازیکنان اجازه می‌دهد با وارد کردن رمز بازی، نقش‌های خود را دریافت کنند. این پروژه با استفاده از **Cloudflare Workers** و دیتابیس **Cloudflare D1** پیاده‌سازی شده است.

## ویژگی‌ها

- **مدیریت سناریوها**: پشتیبانی از سناریوهای مختلف (بازپرس، نماینده، دراکولا، شب مافیا) با تعداد بازیکنان متفاوت.
- **تخصیص نقش**: تخصیص تصادفی نقش‌ها به بازیکنان با استفاده از رمز بازی.
- **کارت‌های حرکت آخر**: پشتیبانی از کارت‌های حرکت آخر برای سناریوی "شب مافیا".
- **مدیریت گرداننده**: قابلیت نقش دهی دستی به پلیرهایی که دسترسی به تلگرام ندارند، قابلیت توزیع مجدد نقش ها بدون نیاز به تعریف مجدد سناریو، مشاهده فهرست نقش های توزیع شده و توزیع نشده
- **ذخیره‌سازی پایدار**: استفاده از دیتابیس Cloudflare D1 برای ذخیره‌سازی داده‌های بازی.
- **رابط کاربری ساده**: کیبوردهای اینلاین و معمولی برای تعامل آسان با بات.
- **پشتیبانی از زبان فارسی**: تمام پیام‌ها و رابط کاربری به زبان فارسی طراحی شده‌اند.

## پیش‌نیازها

برای استقرار و استفاده از این بات، به موارد زیر نیاز دارید:

- حساب [Cloudflare](https://www.cloudflare.com/).
- توکن بات تلگرامی از [BotFather](https://t.me/BotFather) در تلگرام.
- آشنایی با داشبورد Cloudflare.

## راهنمای نصب و استقرار (از طریق پنل Cloudflare)

### 1. دانلود فایل ورکر worker.js یا کپی کردن محتوای فایل

### 2. ایجاد Worker در Cloudflare
1. به داشبورد Cloudflare ([https://dash.cloudflare.com](https://dash.cloudflare.com)) وارد شوید.
2. از منوی سمت چپ، به بخش **Workers and Pages** بروید.
3. روی دکمه **Create Worker** کلیک کنید.
4. یک نام برای Worker خود انتخاب کنید (مثلاً `mafia-bot`) و روی **Deploy** کلیک کنید.
5. پس از ایجاد Worker، روی **Edit Code** کلیک کنید.
6. محتوای فایل `index.js` از مخزن پروژه را کپی کرده و در ویرایشگر کد Cloudflare جای‌گذاری کنید.
7. روی **Save and Deploy** کلیک کنید.

### 3. تنظیم متغیرهای محیطی
1. در داشبورد Cloudflare، به Worker خود بروید و روی تب **Settings** کلیک کنید.
2. در بخش **Variables**، روی **Edit variables** کلیک کنید.
3. متغیرهای زیر را اضافه کنید:
<div dir="ltr">
  
   - **Name**: `TELEGRAM_BOT_TOKEN`
  
   - **Value**: توکن بات تلگرامی که از BotFather دریافت کرده‌اید (مثلاً `123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11`).
     
   - **Name**: `MASTER_PASSWORD`
     
   - **Value**: رمز مستر دلخواه وارد کنید. ترجیحا ساده و کوتاه
</div>

4. روی **Save** کلیک کنید.


### 4. وب هوک
1. در قسمت settings، قسمت Domains & Routes در سطر اول جدول لینک ورکر خود را کپی و جایی ذخیره کنید (مثلا mafia-bot.you.workers.dev).
2. مرورگر خود را باز کنید و درخواست زیر را برای تنظیم Webhook ارسال کنید:

<div dir="ltr">
  
https://api.telegram.org/bot<توکن تلگرام>/setWebhook?url=https://<لینک ورکر شما>
</div>
مثال:
<div dir="ltr">
  
https://api.telegram.org/bot123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11/setWebhook?url=https://mafia-bot.example.workers.dev/
</div>

3. در صورت موفقیت، پاسخی مانند {"ok":true,"result":true,"description":"Webhook was set"} دریافت خواهید کرد.


### 5. ایجاد و پیکربندی دیتابیس D1
1. در داشبورد Cloudflare، از منوی سمت چپ به بخش storage and databases و سپس به **D1** بروید.
2. روی **Create Database** کلیک کنید و یک نام برای دیتابیس انتخاب کنید (مثلاً `mafia-bot-db`)..
3. به Worker خود برگردید و در بخش **Settings > Bindings**، یک Binding جدید از نوع **D1 Database** اضافه کنید:
   - **Variable Name**: `D1_DATABASE`
   - **Database**: دیتابیس ایجادشده (مثلاً `mafia-bot-db`).
5. در بخش **D1**، روی دیتابیس خود کلیک کنید و به تب **Query** بروید.
6. دستورات SQL زیر را برای ایجاد جداول اجرا کنید:
   ```sql
   CREATE TABLE game_data (id TEXT PRIMARY KEY, data TEXT);
   CREATE TABLE player_names (id TEXT PRIMARY KEY, data TEXT);

###  نکات استفاده
رمز بازی برای هر بازی توسط گرداننده تعیین میشود و به بازیکنان اعلام میشود. ترجیحا از یک رمز تک رقمی یا تک حرفی استفاده کنید.

در هر مرحله از استفاده از بات میتوانید با استفاده از دستور /r بات را ریست کنید.

برای آشنایی با سناریوی دراکولا این ریپازیتوری را مطالعه فرمایید.
https://github.com/spyblaster/dracula/
   
